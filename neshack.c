
/*
CHR-RAM example with extra PRG banks. Pressing the 
`A` button will load different tiles from different 
PRG banks into CHR-RAM. This example is designed to 
work with 8bitworkshop. I have found no way on 
8bitworkshop to expand to more than four 16KB PRG 
banks.
*/

#include <peekpoke.h>
#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include <nes.h>
#include "neslib.h"

#define NES_MAPPER 4    // Mapper 4 (MMC3)
#define NES_PRG_BANKS 4 // # of 16KB PRG banks
#define NES_CHR_BANKS 0 // CHR RAM

#define MMC_MODE 0

#define MMC3_SET_REG(r,n)\
  POKE(0x8000, MMC_MODE|(r));\
  POKE(0x8001, (n));

#define MMC3_PRG_8000(n) MMC3_SET_REG(6,n)
#define MMC3_PRG_A000(n) MMC3_SET_REG(7,n)
#define MMC3_PRG_A400(n) MMC3_SET_REG(8,n)

#define MMC3_MIRROR(n) POKE(0xa000, (n))

#pragma rodata-name("CODE0")
const unsigned char TEXT0[]={"Bank 0 @ 8000"};
#pragma rodata-name("CODE1")
const unsigned char TEXT1[]={"Bank 1 @ 8000"};
#pragma rodata-name("CODE2")
const unsigned char TEXT2[]={"Bank 2 @ 8000"};
#pragma rodata-name("CODE3")
const unsigned char TEXT3[]={"Bank 3 @ A000"};
#pragma rodata-name("CODE4")
const unsigned char TEXT4[]={"Bank 4 @ A000"};
#pragma rodata-name("CODE5")
const unsigned char TEXT5[]={"Bank 5 @ A000"};
#pragma rodata-name("CODE6")
const unsigned char TEXT6[]={"Bank 6 @ C000"};

// VRAM update buffer
#include "vrambuf.h"
//#link "vrambuf.c"

#define SSRC_FORM1 64 // name for formation source sprites
#define SDST_FORM1 128  // start of shifted formation table

// PROTOTYPES
void capture_controller_input(void);

// loop variables
unsigned char g;
unsigned char h;
unsigned char i;
unsigned char j;
unsigned char k;
unsigned char l;
unsigned char x;
unsigned char y;

// temp variables
bool temp_bool_1;
unsigned char temp_char_0;
unsigned char temp_char_1;
unsigned char temp_char_2;
unsigned char temp_char_3;
unsigned int temp_int_1;
unsigned int temp_int_2;

// temp arrays
char tile_temp[5];
char pallet_temp_1[15];
char pallet_temp_2[15];

// rng_seed tells us how many times to run the rng loop durring initializing
unsigned int rng_seed = 0;

unsigned char pallet = 0;
unsigned char is_overworld = false;
unsigned char frame_count = 0;
unsigned char pad1;
unsigned char pad1_new;

#pragma rodata-name("CODE3")
// rng_table to use to grab integers from sudo-randomly.
const bool RNG_TABLE[256] = {
  true,  true,  true,  false, true,  false, true,  true,  true,  false,
  false, true,  false, false, false, true,  false, true,  true,  true,
  true,  false, true,  true,  false, true,  false, false, false, true, 
  true,  false, false, true,  true,  false, true,  true,  false, true,
  true,  false, false, false, false, false, true,  true,  false, false,
  false, false, false, true,  false, false, false, true,  false, true,
  false, true,  false, false, true,  false, false, true,  false, false,
  true,  true,  true,  true,  true,  false, true,  true,  true,  false,
  false, true,  false, true,  true,  false, true,  false, true,  false,
  true,  true,  true,  false, false, true,  false, false, false, true,
  
  false, false, false, false, false, false, true,  true,  false, true,
  true,  true,  true,  false, true,  false, true,  false, false, true,
  true,  true,  true,  true,  true,  true,  true,  true,  true,  false,
  false, false, true,  false, true,  false, true,  true,  true,  true,
  false, true,  false, false, true,  false, true,  false, true,  false,
  true,  true,  true,  true,  false, true,  false, false, false, false,
  true,  true,  false, true,  true,  false, true,  false, true,  false,
  false, true,  true,  false, false, false, false, false, true,  true,
  false, false, false, false, false, true,  false, true,  true,  false,
  true,  true,  true,  true,  false, true,  false, false, true,  false,
  
  false, true,  false, true,  false, true,  false, false, false, true,
  true,  true,  true,  true,  true,  true,  false, false, false, false,
  false, true,  true,  true,  false, true,  true,  true,  false, false,
  false, true,  true,  true,  false, true,  false, false, true,  true,
  false, true,  false, false, true,  false, true,  true,  true,  true,
  true,  false, false, true,  true,  true
};

// Here is a simple drng

//RNG should be 1 to 256 values where each value is from 0 to 15.
unsigned char rng_count = 0;
bool rng_direction = true;
unsigned char offset = 1;
unsigned char rng_index = 0;
unsigned char rng_value = 0;

//Algorithm:
void updateRng(){
  if (rng_count == 255) {
    rng_count = 0;
    if (rng_direction) {
      rng_direction = false;
    } else {
      rng_direction = true;
    }
    offset += 2;
  }
  ++rng_count;
  if (rng_direction) {
    rng_index += offset;
  } else {
    rng_index -= offset;
  }
  for (i = 0; i < 32; i+=2) {
    rng_value += RNG_TABLE[rng_index * 32 + i];
  }
  rng_value = rng_value % 10;
}

unsigned char rng_lvl = 0;
unsigned char rng_lvl_counts[30];
bool rng_lvl_directions[30];
unsigned char rng_lvl_offsets[30];
unsigned char rng_lvl_indexes[30];
unsigned char rng_lvl_value = 0;

void setLevelRngValue() {
  temp_char_3 = rng_lvl_indexes[rng_lvl];
  temp_char_1 = 0;
  MMC3_PRG_A000(3);
  if (RNG_TABLE[temp_char_3]) {
    ++temp_char_1;
  }
  if (RNG_TABLE[temp_char_3 + 1]) {
    temp_char_1 += 2;
  }
  if (RNG_TABLE[temp_char_3 + 2]) {
    temp_char_1 += 4;
  }
  rng_lvl_value = temp_char_1;
}

//Algorithm
void updateLevelRng() {
  //calculate updates
  temp_char_1 = rng_lvl_counts[rng_lvl];
  temp_bool_1 = rng_lvl_directions[rng_lvl];
  temp_char_2 = rng_lvl_offsets[rng_lvl];
  temp_char_3 = rng_lvl_indexes[rng_lvl];
  if (temp_char_1 == 255) {
    temp_char_1 = 0;
    if (temp_bool_1) {
      temp_bool_1 = false;
    } else {
      temp_bool_1 = true;
    }
    temp_char_2 += 2;
  }
  ++temp_char_1;
  if (temp_bool_1) {
    temp_char_3 += temp_char_2;
  } else {
    temp_char_3 -= temp_char_2;
  }
  //set updates
  rng_lvl_counts[rng_lvl] = temp_char_1;
  rng_lvl_directions[rng_lvl] = temp_bool_1;
  rng_lvl_offsets[rng_lvl] = temp_char_2;
  rng_lvl_indexes[rng_lvl] = temp_char_3;
  //set rng value for retrieval
  setLevelRngValue();
}

// The `initializeLevelRngIndex` is the `updateLevelRngIndex` functionality 
// duplicated in a loop. This is needed because wrapping the `updateLevelRngIndex` 
// function call in a loop is too slow.
void initializeLevelRngIndex(void) {
  temp_char_1 = 0;
  temp_bool_1 = true;
  temp_char_2 = 1;
  temp_char_3 = 0;
  for (temp_int_1 = 0; temp_int_1 < rng_seed; temp_int_1++) {
    //calculate updates
    if (temp_char_1 == 255) {
      temp_char_1 = 0;
      if (temp_bool_1) {
        temp_bool_1 = false;
      } else {
        temp_bool_1 = true;
      }
      temp_char_2 += 2;
    }
    ++temp_char_1;
    if (temp_bool_1) {
      temp_char_3 += temp_char_2;
    } else {
      temp_char_3 -= temp_char_2;
    }
  }
  //set updates
  rng_lvl_counts[rng_lvl] = temp_char_1;
  rng_lvl_directions[rng_lvl] = temp_bool_1;
  rng_lvl_offsets[rng_lvl] = temp_char_2;
  rng_lvl_indexes[rng_lvl] = temp_char_3;
  //set rng value for retrieval
  setLevelRngValue();
}










#pragma rodata-name("CODE6")




/*{pal:"nes",layout:"nes"}*/
const char PALETTE[32] = { 
  0x00,     // screen color

  0x30,0x0D,0x17,0x00,  // background palette 0
  0x12,0x22,0x2D,0x00,  // background palette 1
  0x00,0x17,0x27,0x00,  // background palette 2
  0x25,0x16,0x1A,0x00,  // background palette 3

  0x00,0x2D,0x2C,0x00,  // sprite palette 0
  0x0D,0x17,0x28,0x00,  // sprite palette 1
  0x0D,0x00,0x3A,0x00,  // sprite palette 2
  0x0D,0x27,0x2A  // sprite palette 3
};

const unsigned char UPPERCASE_FONT[4*256] = {
/*{w:8,h:8,bpp:1,count:64,brev:1,np:2,pofs:8,remap:[0,1,2,4,5,6,7,8,9,10,11,12]}*/
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x18,0x3C,0x3C,0x3C,0x18,0x00,0x18,0x00,0xE7,0xC3,0xC3,0xC3,0xE7,0xFF,0xE7,0xFF,0x6C,0x6C,0x6C,0x00,0x00,0x00,0x00,0x00,0x93,0x93,0x93,0xFF,0xFF,0xFF,0xFF,0xFF,0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00,0x93,0x93,0x01,0x93,0x01,0x93,0x93,0xFF,0x30,0x7C,0xC0,0x78,0x0C,0xF8,0x30,0x00,0xCF,0x83,0x3F,0x87,0xF3,0x07,0xCF,0xFF,0x00,0xC6,0xCC,0x18,0x30,0x66,0xC6,0x00,0xFF,0x39,0x33,0xE7,0xCF,0x99,0x39,0xFF,0x38,0x6C,0x38,0x76,0xDC,0xCC,0x76,0x00,0xC7,0x93,0xC7,0x89,0x23,0x33,0x89,0xFF,0x60,0x60,0xC0,0x00,0x00,0x00,0x00,0x00,0x9F,0x9F,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0x18,0x30,0x60,0x60,0x60,0x30,0x18,0x00,0xE7,0xCF,0x9F,0x9F,0x9F,0xCF,0xE7,0xFF,0x60,0x30,0x18,0x18,0x18,0x30,0x60,0x00,0x9F,0xCF,0xE7,0xE7,0xE7,0xCF,0x9F,0xFF,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0xFF,0x99,0xC3,0x00,0xC3,0x99,0xFF,0xFF,0x00,0x30,0x30,0xFC,0x30,0x30,0x00,0x00,0xFF,0xCF,0xCF,0x03,0xCF,0xCF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x60,0xFF,0xFF,0xFF,0xFF,0xFF,0xCF,0xCF,0x9F,0x00,0x00,0x00,0xFC,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x03,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xCF,0xCF,0xFF,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0xF9,0xF3,0xE7,0xCF,0x9F,0x3F,0x7F,0xFF,
0x38,0x4C,0xC6,0xC6,0xC6,0x64,0x38,0x00,0xC7,0xB3,0x39,0x39,0x39,0x9B,0xC7,0xFF,0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00,0xE7,0xC7,0xE7,0xE7,0xE7,0xE7,0x81,0xFF,0x7C,0xC6,0x0E,0x3C,0x78,0xE0,0xFE,0x00,0x83,0x39,0xF1,0xC3,0x87,0x1F,0x01,0xFF,0x7E,0x0C,0x18,0x3C,0x06,0xC6,0x7C,0x00,0x81,0xF3,0xE7,0xC3,0xF9,0x39,0x83,0xFF,0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x0C,0x00,0xE3,0xC3,0x93,0x33,0x01,0xF3,0xF3,0xFF,0xFC,0xC0,0xFC,0x06,0x06,0xC6,0x7C,0x00,0x03,0x3F,0x03,0xF9,0xF9,0x39,0x83,0xFF,0x3C,0x60,0xC0,0xFC,0xC6,0xC6,0x7C,0x00,0xC3,0x9F,0x3F,0x03,0x39,0x39,0x83,0xFF,0xFE,0xC6,0x0C,0x18,0x30,0x30,0x30,0x00,0x01,0x39,0xF3,0xE7,0xCF,0xCF,0xCF,0xFF,0x7C,0xC6,0xC6,0x7C,0xC6,0xC6,0x7C,0x00,0x83,0x39,0x39,0x83,0x39,0x39,0x83,0xFF,0x7C,0xC6,0xC6,0x7E,0x06,0x0C,0x78,0x00,0x83,0x39,0x39,0x81,0xF9,0xF3,0x87,0xFF,0x00,0x30,0x30,0x00,0x00,0x30,0x30,0x00,0xFF,0xCF,0xCF,0xFF,0xFF,0xCF,0xCF,0xFF,0x00,0x30,0x30,0x00,0x00,0x30,0x30,0x60,0xFF,0xCF,0xCF,0xFF,0xFF,0xCF,0xCF,0x9F,0x18,0x30,0x60,0xC0,0x60,0x30,0x18,0x00,0xE7,0xCF,0x9F,0x3F,0x9F,0xCF,0xE7,0xFF,0x00,0x00,0xFC,0x00,0x00,0xFC,0x00,0x00,0xFF,0xFF,0x03,0xFF,0xFF,0x03,0xFF,0xFF,0x60,0x30,0x18,0x0C,0x18,0x30,0x60,0x00,0x9F,0xCF,0xE7,0xF3,0xE7,0xCF,0x9F,0xFF,0x78,0xCC,0x0C,0x18,0x30,0x00,0x30,0x00,0x87,0x33,0xF3,0xE7,0xCF,0xFF,0xCF,0xFF,
0x7C,0xC6,0xDE,0xDE,0xDE,0xC0,0x78,0x00,0x83,0x39,0x21,0x21,0x21,0x3F,0x87,0xFF,0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0x00,0xC7,0x93,0x39,0x39,0x01,0x39,0x39,0xFF,0xFC,0xC6,0xC6,0xFC,0xC6,0xC6,0xFC,0x00,0x03,0x39,0x39,0x03,0x39,0x39,0x03,0xFF,0x3C,0x66,0xC0,0xC0,0xC0,0x66,0x3C,0x00,0xC3,0x99,0x3F,0x3F,0x3F,0x99,0xC3,0xFF,0xF8,0xCC,0xC6,0xC6,0xC6,0xCC,0xF8,0x00,0x07,0x33,0x39,0x39,0x39,0x33,0x07,0xFF,0xFE,0xC0,0xC0,0xFC,0xC0,0xC0,0xFE,0x00,0x01,0x3F,0x3F,0x03,0x3F,0x3F,0x01,0xFF,0xFE,0xC0,0xC0,0xFC,0xC0,0xC0,0xC0,0x00,0x01,0x3F,0x3F,0x03,0x3F,0x3F,0x3F,0xFF,0x3E,0x60,0xC0,0xCE,0xC6,0x66,0x3E,0x00,0xC1,0x9F,0x3F,0x31,0x39,0x99,0xC1,0xFF,0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0x00,0x39,0x39,0x39,0x01,0x39,0x39,0x39,0xFF,0x7E,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x81,0xE7,0xE7,0xE7,0xE7,0xE7,0x81,0xFF,0x1E,0x06,0x06,0x06,0x66,0x66,0x3C,0x00,0xE1,0xF9,0xF9,0xF9,0x99,0x99,0xC3,0xFF,0xC6,0xCC,0xD8,0xF0,0xF8,0xDC,0xCE,0x00,0x39,0x33,0x27,0x0F,0x07,0x23,0x31,0xFF,0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00,0x9F,0x9F,0x9F,0x9F,0x9F,0x9F,0x81,0xFF,0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0x00,0x39,0x11,0x01,0x01,0x29,0x39,0x39,0xFF,0xC6,0xE6,0xF6,0xFE,0xDE,0xCE,0xC6,0x00,0x39,0x19,0x09,0x01,0x21,0x31,0x39,0xFF,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x83,0x39,0x39,0x39,0x39,0x39,0x83,0xFF,
0xFC,0xC6,0xC6,0xC6,0xFC,0xC0,0xC0,0x00,0x03,0x39,0x39,0x39,0x03,0x3F,0x3F,0xFF,0x7C,0xC6,0xC6,0xC6,0xDE,0xCC,0x7A,0x00,0x83,0x39,0x39,0x39,0x21,0x33,0x85,0xFF,0xFC,0xC6,0xC6,0xCE,0xF8,0xDC,0xCE,0x00,0x03,0x39,0x39,0x31,0x07,0x23,0x31,0xFF,0x78,0xCC,0xC0,0x7C,0x06,0xC6,0x7C,0x00,0x87,0x33,0x3F,0x83,0xF9,0x39,0x83,0xFF,0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x81,0xE7,0xE7,0xE7,0xE7,0xE7,0xE7,0xFF,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x39,0x39,0x39,0x39,0x39,0x39,0x83,0xFF,0xC6,0xC6,0xC6,0xEE,0x7C,0x38,0x10,0x00,0x39,0x39,0x39,0x11,0x83,0xC7,0xEF,0xFF,0xC6,0xC6,0xD6,0xFE,0xFE,0xEE,0xC6,0x00,0x39,0x39,0x29,0x01,0x01,0x11,0x39,0xFF,0xC6,0xEE,0x7C,0x38,0x7C,0xEE,0xC6,0x00,0x39,0x11,0x83,0xC7,0x83,0x11,0x39,0xFF,0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x00,0x99,0x99,0x99,0xC3,0xE7,0xE7,0xE7,0xFF,0xFE,0x0E,0x1C,0x38,0x70,0xE0,0xFE,0x00,0x01,0xF1,0xE3,0xC7,0x8F,0x1F,0x01,0xFF,0x78,0x60,0x60,0x60,0x60,0x60,0x78,0x00,0x87,0x9F,0x9F,0x9F,0x9F,0x9F,0x87,0xFF,0xC0,0x60,0x30,0x18,0x0C,0x06,0x02,0x00,0x3F,0x9F,0xCF,0xE7,0xF3,0xF9,0xFD,0xFF,0x78,0x18,0x18,0x18,0x18,0x18,0x78,0x00,0x87,0xE7,0xE7,0xE7,0xE7,0xE7,0x87,0xFF,0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0xEF,0xC7,0x93,0x39,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00
};

void setup_uppercase_font(int start) {
  // copy background
  vram_adr(start);
  vram_write(UPPERCASE_FONT, sizeof(UPPERCASE_FONT));
  // activate vram buffer
  vrambuf_clear();
  set_vram_update(updbuf);
}

const unsigned char LOWERCASE_FONT[2*256] = {
/*{w:8,h:8,bpp:1,count:32,brev:1,np:2,pofs:8,remap:[0,1,2,4,5,6,7,8,9,10,11,12]}*/
0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00,0xCF,0xCF,0xE7,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x3C,0x66,0x66,0x66,0x3B,0x00,0xFF,0xFF,0xC3,0x99,0x99,0x99,0xC4,0xFF,0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0x00,0x9F,0x9F,0x83,0x99,0x99,0x99,0x83,0xFF,0x00,0x00,0x3E,0x60,0x60,0x60,0x3E,0x00,0xFF,0xFF,0xC1,0x9F,0x9F,0x9F,0xC1,0xFF,0x06,0x06,0x3E,0x66,0x66,0x66,0x3E,0x00,0xF9,0xF9,0xC1,0x99,0x99,0x99,0xC1,0xFF,0x00,0x00,0x3E,0x63,0x7F,0x60,0x3F,0x00,0xFF,0xFF,0xC1,0x9C,0x80,0x9F,0xC0,0xFF,0x0E,0x18,0x18,0x7E,0x18,0x18,0x18,0x00,0xF1,0xE7,0xE7,0x81,0xE7,0xE7,0xE7,0xFF,0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x3C,0xFF,0xFF,0xC1,0x99,0x99,0xC1,0xF9,0xC3,0x60,0x60,0x60,0x7C,0x66,0x66,0x66,0x00,0x9F,0x9F,0x9F,0x83,0x99,0x99,0x99,0xFF,0x00,0x18,0x00,0x18,0x18,0x18,0x18,0x00,0xFF,0xE7,0xFF,0xE7,0xE7,0xE7,0xE7,0xFF,0x00,0x06,0x00,0x06,0x06,0x06,0x66,0x3C,0xFF,0xF9,0xFF,0xF9,0xF9,0xF9,0x99,0xC3,0x60,0x60,0x62,0x64,0x68,0x7C,0x66,0x00,0x9F,0x9F,0x9D,0x9B,0x97,0x83,0x99,0xFF,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0xE7,0xE7,0xE7,0xE7,0xE7,0xE7,0xE7,0xFF,0x00,0x00,0x76,0x6B,0x6B,0x6B,0x6B,0x00,0xFF,0xFF,0x89,0x94,0x94,0x94,0x94,0xFF,0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x00,0xFF,0xFF,0x83,0x99,0x99,0x99,0x99,0xFF,0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00,0xFF,0xFF,0xC3,0x99,0x99,0x99,0xC3,0xFF,
0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x60,0xFF,0xFF,0x83,0x99,0x99,0x83,0x9F,0x9F,0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x06,0xFF,0xFF,0xC1,0x99,0x99,0xC1,0xF9,0xF9,0x00,0x00,0x6E,0x70,0x60,0x60,0x60,0x00,0xFF,0xFF,0x91,0x8F,0x9F,0x9F,0x9F,0xFF,0x00,0x00,0x3C,0x40,0x3C,0x06,0x7C,0x00,0xFF,0xFF,0xC3,0xBF,0xC3,0xF9,0x83,0xFF,0x30,0x30,0xFC,0x30,0x30,0x30,0x1C,0x00,0xCF,0xCF,0x03,0xCF,0xCF,0xCF,0xE3,0xFF,0x00,0x00,0x66,0x66,0x66,0x66,0x3C,0x00,0xFF,0xFF,0x99,0x99,0x99,0x99,0xC3,0xFF,0x00,0x00,0x66,0x66,0x66,0x24,0x18,0x00,0xFF,0xFF,0x99,0x99,0x99,0xDB,0xE7,0xFF,0x00,0x00,0x63,0x6B,0x6B,0x6B,0x36,0x00,0xFF,0xFF,0x9C,0x94,0x94,0x94,0xC9,0xFF,0x00,0x00,0x63,0x36,0x1C,0x36,0x63,0x00,0xFF,0xFF,0x9C,0xC9,0xE3,0xC9,0x9C,0xFF,0x00,0x00,0x66,0x66,0x2C,0x18,0x30,0x60,0xFF,0xFF,0x99,0x99,0xD3,0xE7,0xCF,0x9F,0x00,0x00,0x7E,0x0C,0x18,0x30,0x7E,0x00,0xFF,0xFF,0x81,0xF3,0xE7,0xCF,0x81,0xFF,0x1C,0x30,0x30,0xE0,0x30,0x30,0x1C,0x00,0xE3,0xCF,0xCF,0x1F,0xCF,0xCF,0xE3,0xFF,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00,0xE7,0xE7,0xE7,0xFF,0xE7,0xE7,0xE7,0xFF,0xE0,0x30,0x30,0x1C,0x30,0x30,0xE0,0x00,0x1F,0xCF,0xCF,0xE3,0xCF,0xCF,0x1F,0xFF,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x89,0x23,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0x00,0xFF,0xEF,0xC7,0x93,0x39,0x39,0x01,0xFF,
};

void setup_lowercase_font(int start) {
  // copy background
  vram_adr(start);
  vram_write(LOWERCASE_FONT, sizeof(LOWERCASE_FONT));
  // activate vram buffer
  vrambuf_clear();
  set_vram_update(updbuf);
}

const unsigned char MAP_COMMON[2*256] = {
/*{w:8,h:8,bpp:1,count:32,brev:1,np:2,pofs:8,remap:[0,1,2,4,5,6,7,8,9,10,11,12]}*/
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3C,0x3C,0x00,0x3C,0x24,0x24,0x00,0x00,0x3C,0x3C,0x00,0x3C,0x24,0x24,0x00,0xFF,0xFF,0x7E,0x42,0x18,0x72,0x66,0x00,0xFF,0xFF,0x00,0x3C,0x66,0x0C,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x1F,0x3F,0x3F,0x7F,0x7F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0xE0,0xF8,0xFC,0xFC,0xFE,0xFE,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x07,0x0E,0x18,0x31,0x31,0x33,0x00,0x00,0x07,0x0E,0x18,0x31,0x31,0x33,0x00,0x00,0xF0,0x38,0xF8,0x98,0x18,0x18,0x00,0x00,0xF0,0x38,0xF8,0x98,0x18,0x18,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x08,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xDB,0xA5,0x42,0x00,0x00,0x00,0x42,0x81,0x24,0x66,0xC3,0x81,0x81,0x81,0xC3,0x7E,0x7E,0x66,0x7E,0xFF,0xFF,0x00,0x00,0x00,0x00,0x18,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xF0,0xF0,0xF0,0xF0,0xE0,0xE0,0xC0,0xF0,0xF1,0xF1,0xF0,0xF0,0xE0,0xE0,0xC0,0x07,0x0F,0x0F,0x0F,0x0F,0x07,0x07,0x03,0x0F,0x8F,0x8F,0x0F,0x0F,0x07,0x07,0x03,0x33,0x33,0x33,0x31,0x18,0x0F,0x00,0x00,0x33,0x33,0x33,0x31,0x18,0x0F,0x00,0x00,0x18,0x38,0xF8,0xFC,0x0C,0xC0,0x00,0x00,0x18,0x38,0xF8,0xFC,0x0C,0xC0,0x00,0x00,
};

void setup_map_common(int start) {
  // copy background
  vram_adr(start);
  vram_write(MAP_COMMON, sizeof(MAP_COMMON));
  // activate vram buffer
  vrambuf_clear();
  set_vram_update(updbuf);
}

const unsigned char MAP_ENEMY[8*256] = {
/*{w:8,h:8,bpp:1,count:128,brev:1,np:2,pofs:8,remap:[0,1,2,4,5,6,7,8,9,10,11,12]}*/
0x00,0x00,0x00,0x30,0x08,0x18,0x3C,0x22,0x00,0x00,0x00,0x30,0x08,0x1E,0x3F,0x23,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1C,0x3C,0x78,0xE0,0x00,0x00,0x00,0x00,0x02,0x02,0x02,0x02,0x00,0x00,0x03,0x03,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x02,0x02,0x02,0x04,0x78,0x78,0xFC,0x9E,0x0C,0x0C,0x9C,0xF8,0x00,0x00,0x00,0x00,0x00,0x03,0x0F,0x1E,0x3C,0x00,0x0F,0x19,0x00,0x03,0x0F,0x1E,0x3C,0x00,0x00,0x00,0x00,0xF0,0xF8,0x18,0x08,0x00,0xC0,0xE0,0xE0,0xF0,0xF8,0x18,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x0F,0x1E,0x3C,0x30,0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xF8,0x00,0x00,0x00,0x00,0x00,0x08,0xE0,0xE0,0xE0,0x00,0xE0,0xE0,0xE0,0x08,0xE0,0x20,0x20,0x00,0x00,0x60,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x03,0x0B,0x0B,0x43,0x43,0x4B,0x0B,0x00,0x03,0x1F,0x3F,0x63,0x63,0x7F,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x60,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x60,0x00,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x70,0xC4,0x0E,0x06,0x06,0x04,0xEC,0x78,0x78,0xF8,0x80,0x02,0x06,0x8E,0x90,0x60,0x30,0x30,0x30,0x3C,0x1E,0x0F,0x03,0x00,0x30,0x30,0x30,0x3C,0x1E,0x0F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xF8,0x00,0x00,0x00,0x00,0x40,0x40,0x40,0x20,0x1C,0x1E,0x3F,0x79,0x70,0x70,0x79,0x3F,0x1E,0x00,0x20,0x04,0x21,0x3F,0x3F,0x1F,0x00,0x00,0x00,0x04,0x20,0x14,0x0F,0x0F,0x00,0xE0,0xE0,0xE4,0xE0,0xE0,0xC0,0x80,0x00,0x80,0x60,0x60,0x80,0xC0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xDB,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0xDB,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0xDB,0xDB,0x00,0x00,0x00,0x00,0x00,0x00,0xDB,0xDB,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
void setup_map_enemy(int start) {
  vram_adr(start);
  //vram_write(&MAP_ENEMY[24 * 64], 64);
  vram_write(MAP_ENEMY, sizeof(MAP_ENEMY));
  vrambuf_clear();
  set_vram_update(updbuf);
}
#pragma rodata-name("CODE6")
// Main PRG bank that is always accessible.

char map[13 * 30];

void writeMapRow(char rowIndex, char* map_row) {
  for (i = 0; i < 30; ++i) {
    map[rowIndex * 30 + i] = map_row[i];
  }
}

void writeMap(void) {
  writeMapRow( 0, "j #               #           ");
  writeMapRow( 1, "  j           # # #           ");
  writeMapRow( 2, "j # # - - - - + - - - -       ");
  writeMapRow( 3, "    # | . . . . . . . |       ");
  writeMapRow( 4, "    # | . . . . . . . |       ");
  writeMapRow( 5, "    # + a a0a1b b0b1. |       ");
  writeMapRow( 6, "      | . j @ c c0c1?A|       ");
  writeMapRow( 7, "      | . . A C !A!B!C|       ");
  writeMapRow( 8, "      - - - - - - - |+-       ");
  writeMapRow( 9, "- - - -             # # # # # ");
  writeMapRow(10, ". . . -+# #           #       ");
  writeMapRow(11, ". . . |   # # # # # # #       ");
  writeMapRow(12, ". . . |           # # #       ");
}

char bgtiles[32];
char bg_tile_top[2];
char bg_tile_bottom[2];
char bg_tiles_top[30];
char bg_tiles_bottom[30];

const char MOCKUP_TILE[64] = {
/*{w:16,h:16,bpp:1,count:1,brev:1,np:2,pofs:8,remap:[5,0,1,2,4,6,7,8,9,10,11,12]}*/  
0x0F,0x0F,0x1F,0x3F,0x3F,0x7F,0x7F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xEF,0xFE,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xF0,0xF0,0xF8,0xFC,0xFC,0xFE,0xFE,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xF7,0x7F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
};

#define AE(tl,tr,bl,br) (((tl)<<0)|((tr)<<2)|((bl)<<4)|((br)<<6))

// this is attribute table data, 
// each 2 bits defines a color palette
// for a 16x16 box
unsigned char ATTRIBUTE_TABLE[0x40]={
  0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0,
  0,0,0,0,0,0,0,0
};

//--------------------------------------------------------
// Define Large Tile (https://nethackwiki.com/wiki/Symset)
//--------------------------------------------------------
// CATALOGUE_SIZE is the amount of defined tiles
// LARGE_TILE_SIZE is the amount of data per tile
// LARGE_TILES[0] is the overworld map's primary character
// LARGE_TILES[1] is the overworld map's subspecies
// LARGE_TILES[2] is the upper left tile
// LARGE_TILES[3] is the upper right tile
// LARGE_TILES[4] is the lower left tile
// LARGE_TILES[5] is the lower right tile
// LARGE_TILES[6] is the tile's pallet
// LARGE_TILES[7] is the sprite or zero when not in use
// LARGE_TILES[8] is the sprite's x-offset from the tile's upper right corner
// LARGE_TILES[9] is the sprite's y-offset from the tile's upper right corner
// LARGE_TILES[10] is the sprite's pallet
//------------------
const char CATALOGUE_SIZE = 29;
const char LARGE_TILE_SIZE = 11;
const char LARGE_TILES[29 * 11 + 1] = {
  '@',' ', 14, 15, 30, 31,  2,  0,  0,  0,  0, //Hero
  '+',' ', 12, 13,  1,  1,  0, 43,  5,  6,  1, //Dungeon Door - Closed
  '|','+', 12, 13, 28, 29,  0, 16,  4,  1,  0, //Dungeon Door - Open
  '-','+', 12, 13, 28, 29,  0, 16,  4,  1,  0, //Dungeon Door - Open
  '.',' ',  0,  0,  0, 17,  0,  0,  0,  0,  0, //Dungeon Floor
  '#',' ', 18, 18, 18, 17,  0,  0,  0,  0,  0, //Dungeon Corridor
  ' ',' ', 32, 32, 32, 32,  0,  0,  0,  0,  0, //Dungeon Mass
  '-',' ',  1,  1,  1,  1,  1,  0,  0,  0,  0, //Dungeon Horizontal Wall
  '|',' ',  1,  1,  1,  1,  1,  0,  0,  0,  0, //Dungeon Vertical Wall
  '.','0',  0,  0,  0, 17,  0,  0,  0,  0,  0, //Cave Floor
  '#','0', 18, 18, 18, 17,  0,  0,  0,  0,  0, //Cave Corridor
  ' ','0',  1,  1,  1,  1,  0,  0,  0,  0,  0, //Cave Mass
  '-','0',  1,  1,  1,  1,  2,  0,  0,  0,  0, //Dungeon Horizontal Wall
  '|','0',  1,  1,  1,  1,  2,  0,  0,  0,  0, //Dungeon Vertical Wall
  //------------------------------------------------------
  // Items
  //------------------------------------------------------
  '!','A',  0,  4,  0,'A',  1, 20,  8,  8,  0, //Potion A
  '!','B',  0,  4,  0,'B',  1, 20,  8,  8,  0, //Potion B
  '!','C',  0,  4,  0,'C',  1, 20,  8,  8,  0, //Potion C
  '?','A',  0,  5,  0, 21,  0,  0,  0,  0,  0, //Scroll A
  //------------------------------------------------------
  // Monsters
  //------------------------------------------------------
  'C',' ',134,135,148,149,  2,  0,  0,  0, 0, //Centaur
  'a',' ',128,  0,144,145,  1,  0,  0,  0, 0, //Ant
  'a','0',128,129,144,145,  2,  0,  0,  0, 0, //Killer Bee
  'a','1',128,129,144,145,  2,240,  1, -3, 1, //Queen Bee
  'b',' ',130,  0,146,147,  3,  0,  0,  0, 0, //Acid Blob
  'b','0',130,  0,146,131,  0,  0,  0,  0, 0, //Quivering Blob
  'b','1',130,  0,146, 43,  3,  0,  0,  0, 0, //Gelatinous Cube
  'c',' ',132,  0,  0,  0,  1,150,  2,  4, 0, //Chickatrice
  'c','0',132,133,148,149,  1,  0,  0,  0, 0, //Cockatrice
  'c','1',132,133,148,149,  3,241,  4, -7, 1, //Pyrolisk
  'j',' ',  0,136,151,152,  3,  0,  0,  0, 0, //Jelly
  -1
};

void draw_overworld(void) {
  writeMap();

  //load tiles
  ppu_off();
//  MMC3_PRG_A000(5);
  setup_uppercase_font(256*2);
  setup_lowercase_font(256*6);
  ppu_on_all();
  
  for (i = 0; i < 64; i++) {
    ATTRIBUTE_TABLE[i] = 0x0;//0x55;
  }
  for (j = 0; j < 15; ++j) {
    pallet_temp_1[j] = 0;
  }
  for (i = 0; i < 13; ++i) {
    for (j = 0; j < 15; ++j) {
      temp_int_1 = i * 30 + j * 2;
      bg_tiles_top[j] = map[temp_int_1];
    }
    vrambuf_put(NTADR_A(0,i+2), bg_tiles_top, 30);
  }
  
  MMC3_PRG_A000(3);
  updateRng();
  sprintf(bgtiles, "RNG: %1d", rng_lvl_value);
  vrambuf_put(NTADR_A(0,27), bgtiles, 30);
  
  ppu_off();
  vram_adr(0x23c0);
  vram_write(ATTRIBUTE_TABLE, 0x40);
  ppu_on_all();
}

void draw_map(void) {
  writeMap();

  //load tiles
  ppu_off();
//  MMC3_PRG_A000(3)
//  MMC3_PRG_A000(5);
  setup_map_common(0);
  setup_uppercase_font(256*2);
  setup_lowercase_font(256*6);
//  setup_insect_tile(256*8);
  setup_map_enemy(256*8);
  ppu_on_all();

  for (j = 0; j < 15; ++j) {
    pallet_temp_1[j] = 0;
  }
  g = 0;
  for (i = 0; i < 13; ++i) {
    for (j = 0; j < 15; ++j) {
      temp_int_1 = i * 30 + j * 2;
      for (k = 0; k < CATALOGUE_SIZE; ++k) {
        temp_int_2 = k * LARGE_TILE_SIZE;
        if (LARGE_TILES[temp_int_2] == map[temp_int_1] 
            && LARGE_TILES[temp_int_2 + 1] == map[temp_int_1 + 1]
           ) {
          tile_temp[0] = LARGE_TILES[temp_int_2+2];
          tile_temp[1] = LARGE_TILES[temp_int_2+3];
          tile_temp[2] = LARGE_TILES[temp_int_2+4];
          tile_temp[3] = LARGE_TILES[temp_int_2+5];
          tile_temp[4] = LARGE_TILES[temp_int_2+6];
          if (LARGE_TILES[temp_int_2 + 7] != 0) {
            x = (j + 1) * 16 - 8 + LARGE_TILES[temp_int_2 + 8];
            y = (i + 1) * 16 - 1 + LARGE_TILES[temp_int_2 + 9];
            g = oam_spr(x, y, LARGE_TILES[temp_int_2 + 7], LARGE_TILES[temp_int_2 + 10], g);
          }
          break;
        }
      }
      bg_tiles_top[j*2] = tile_temp[0];
      bg_tiles_top[j*2+1] = tile_temp[1];
      bg_tiles_bottom[j*2] = tile_temp[2];
      bg_tiles_bottom[j*2+1] = tile_temp[3];
      if (i & 1) {
        pallet_temp_1[j] = tile_temp[4];
      } else {
        pallet_temp_2[j] = tile_temp[4];
      }
    }
    vrambuf_put(NTADR_A(0,i*2+2), bg_tiles_top, 30);
    vrambuf_put(NTADR_A(0,i*2+3), bg_tiles_bottom, 30);
    if (!(i & 1)) {
      for (j = 0; j < 8; ++j) {
        ATTRIBUTE_TABLE[i * 4 + j] = AE(pallet_temp_1[j * 2],pallet_temp_1[j * 2 + 1],pallet_temp_2[j * 2],pallet_temp_2[j * 2 + 1]);
      }
    }
  }
// Sets last row of background pallet to zero. Only needed on overworld map?  
//  for (j = 0; j < 15; ++j) {
//    pallet_temp_2[j] = 0;
//  }
  for (j = 0; j < 8; ++j) {
    ATTRIBUTE_TABLE[i * 4 + j] = AE(pallet_temp_1[j * 2],pallet_temp_1[j * 2 + 1],pallet_temp_2[j * 2],pallet_temp_2[j * 2 + 1]);
  }
  ppu_off();
  vram_adr(0x23c0);
  vram_write(ATTRIBUTE_TABLE, 0x40);
  ppu_on_all();
}

void game_loop() {
  draw_map();
    
  // infinite loop
  while (1) {
    // wait for next frame
    ppu_wait_nmi();
    // get do controller logic
    capture_controller_input();

    
    
    vrambuf_put(NTADR_A(0, 1), "                            II", 30);
    //clicking select pulls this up?
    //vrambuf_put(NTADR_A(0,28), "II  II  II  II  II  II  II  II", 30);
    //vrambuf_put(NTADR_A(0,29), "II  II  II  II  II  II  II  II", 30);
    
    
    for (j = 10; j < 24; j++) {
      updateLevelRng();
      // write message to string array
      
      sprintf(bgtiles, " RNG: %1d", rng_lvl_value);
      // write string array into VRAM buffer
      // if buffer is full this will wait for next frame
      vrambuf_put(NTADR_C(1,j), bgtiles, 30);   
    }
  }
}

void capture_controller_input(void) {
  // read the first controller
  pad1_new = pad_trigger(0);
  pad1 = pad_state(0);
  
  // when `A` pressed change tileset.
  if(pad1_new & PAD_A) {
    if (is_overworld) {
      is_overworld = false;
      draw_map();
    } else {
      is_overworld = true;
      draw_overworld();
    }
  }
}

// main function, run after console reset.
// Must be in accessable bank.
void main(void) {
  
  // set palette colors
  pal_all(PALETTE);

  // fix display
  scroll(-8, 0);
  
  initializeLevelRngIndex();
    
  // game loop
  game_loop();
}

